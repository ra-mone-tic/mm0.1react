<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MeowMap - Карта Калининграда</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        #map {
            height: 100vh;
            width: 100%;
        }
        #search-container {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background-color: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }
        #search-results {
            border: 1px solid #ccc;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 5px;
        }
        #search-results div {
            padding: 8px;
            cursor: pointer;
        }
        #search-results div:hover {
            background-color: #f0f0f0;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="search-container">
        <input type="text" id="search" placeholder="Поиск по карте">
        <button id="search-button">Найти</button>
        <div id="search-results"></div>
    </div>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // Initialize the map centered on Kaliningrad
        var map = L.map(\'map\').setView([54.7104, 20.4522], 12);

        // Add a tile layer using a public OSM server
        L.tileLayer(\'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png\', {
            attribution: \'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors\'
        }).addTo(map);

        // Comments on tile system:
        // The URL uses placeholders {s}, {z}, {x}, {y}:
        // {s}: Subdomain, used for load balancing (e.g., a, b, c.tile.openstreetmap.org)
        // {z}: Zoom level. 0 is the entire world, higher numbers zoom in.
        // {x}: X coordinate of the tile.
        // {y}: Y coordinate of the tile.
        // Each tile is a 256x256 pixel image.

        // Public tile usage limits/rate-limits:
        // OpenStreetMap\\\'s tile usage policy (https://operations.osmfoundation.org/policies/tiles/) 
        // requests that heavy users set up their own tile server or use a commercial provider.
        // Excessive use can lead to IP blocking. This setup is for development/demonstration.

        // Future tile caching/self-hosting plan:
        // For production, consider:
        // 1. Using a tile caching proxy (e.g., mod_tile with Apache, or a custom Nginx setup) to reduce requests to OSM servers.
        // 2. Self-hosting tiles by downloading and serving them from a local server (e.g., using OpenMapTiles or similar).
        // 3. Using a commercial tile provider for guaranteed service levels.

        // Marker functionality
        function loadMarkers() {
            fetch(\'/api/markers\')
                .then(response => response.json())
                .then(markers => {
                    markers.forEach(markerData => {
                        addMarkerToMap(markerData);
                    });
                });
        }

        async function addMarkerToMap(markerData) {
            let popupContent = `<b>${markerData.title}</b><br>${markerData.description || \'\'} <br>`;
            
            // Reverse geocode the coordinates
            const response = await fetch(`/api/reverse_geocode?lat=${markerData.latitude}&lng=${markerData.longitude}`);
            const geoData = await response.json();
            
            if (geoData.name) {
                popupContent += `Адрес: ${geoData.name}<br>`;
            }
            popupContent += `Координаты: ${markerData.latitude.toFixed(4)}, ${markerData.longitude.toFixed(4)}<br>`;
            popupContent += `<button onclick="deleteMarker(${markerData.id})">Удалить</button>`;

            var marker = L.marker([markerData.latitude, markerData.longitude]).addTo(map);
            marker.bindPopup(popupContent).openPopup();
            marker.options.markerId = markerData.id; // Store marker ID for deletion
        }

        map.on(\'click\', async function(e) {
            var title = prompt(\'Введите название маркера (на русском):\');
            if (title) {
                var description = prompt(\'Введите описание маркера (необязательно, на русском):\');
                
                const response = await fetch(\'/api/markers\', {
                    method: \'POST\',
                    headers: {
                        \'Content-Type\': \'application/json\'
                    },
                    body: JSON.stringify({
                        lat: e.latlng.lat,
                        lng: e.latlng.lng,
                        title: title,
                        description: description
                    })
                });
                const newMarker = await response.json();
                
                addMarkerToMap({
                    id: newMarker.id,
                    latitude: e.latlng.lat,
                    longitude: e.latlng.lng,
                    title: title,
                    description: description
                });
            }
        });

        function deleteMarker(markerId) {
            if (confirm(\'Вы уверены, что хотите удалить этот маркер?\')) {
                fetch(\'/api/markers/\'+markerId, {
                    method: \'DELETE\'
                })
                .then(response => {
                    if (response.ok) {
                        // Remove marker from map
                        map.eachLayer(function (layer) {
                            if (layer.options && layer.options.markerId === markerId) {
                                map.removeLayer(layer);
                            }
                        });
                    } else {
                        alert(\'Ошибка при удалении маркера.\');
                    }
                });
            }
        }

        // Forward geocoding functionality
        const searchInput = document.getElementById(\'search\');
        const searchButton = document.getElementById(\'search-button\');
        const searchResultsDiv = document.getElementById(\'search-results\');

        searchButton.addEventListener(\'click\', performSearch);
        searchInput.addEventListener(\'keyup\', function(event) {
            if (event.key === \'Enter\') {
                performSearch();
            }
        });

        async function performSearch() {
            const query = searchInput.value;
            if (query.length < 2) {
                searchResultsDiv.innerHTML = \'\';
                return;
            }

            const response = await fetch(`/api/geocode?q=${query}`);
            const results = await response.json();

            searchResultsDiv.innerHTML = \'\';
            if (results.length > 0) {
                results.forEach(result => {
                    const resultItem = document.createElement(\'div\');
                    resultItem.textContent = result.name;
                    resultItem.addEventListener(\'click\', () => {
                        map.setView([result.latitude, result.longitude], 14); // Zoom to result
                        L.marker([result.latitude, result.longitude]).addTo(map)
                            .bindPopup(result.name).openPopup();
                        searchResultsDiv.innerHTML = \'\'; // Clear results after selection
                        searchInput.value = result.name; // Set input to selected name
                    });
                    searchResultsDiv.appendChild(resultItem);
                });
            } else {
                searchResultsDiv.innerHTML = \'<div>Нет результатов</div>\';
            }
        }

        // Load existing markers on page load
        loadMarkers();

    </script>
</body>
</html>


